# Fix –¥–ª—è —á–µ—Ä–Ω–æ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞ –≤ ComfyUI InstantID

## –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å InstantID –Ω–æ–¥–∞–º–∏ –ø–æ–ª—É—á–∞–µ—Ç—Å—è —á–µ—Ä–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç –≤–º–µ—Å—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

## –ü—Ä–∏—á–∏–Ω–∞
**–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å dtype** –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º hardcoded `torch.float16` –≤ InstantID –∫–æ–¥–µ –∏ –Ω–æ–≤—ã–º `torch.bfloat16` VAE –≤ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤–µ—Ä—Å–∏—è—Ö ComfyUI.

### –î–µ—Ç–∞–ª–∏ –∏–∑ –ª–æ–≥–æ–≤:
```
RuntimeWarning: invalid value encountered in cast
VAE load device: cuda:0, offload device: cpu, dtype: torch.bfloat16
```

–ö–æ–≥–¥–∞ `float16` —Ç–µ–Ω–∑–æ—Ä—ã —Å–º–µ—à–∏–≤–∞—é—Ç—Å—è —Å `bfloat16` –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏, –≤–æ–∑–Ω–∏–∫–∞—é—Ç **NaN/Inf –∑–Ω–∞—á–µ–Ω–∏—è**, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≤ —á–µ—Ä–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç.

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã

### –ó–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç:

```bash
cd /path/to/comfyui-instantid-faceswap
python diagnose_system.py
```

–≠—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç –≤–µ—Ä—Å–∏–∏ –≤—Å–µ—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫ –∏ –≤—ã—è–≤–∏—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.

## –†–µ—à–µ–Ω–∏—è

### ‚úÖ –†–µ—à–µ–Ω–∏–µ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π dtype (–£–ñ–ï –ü–†–ò–ú–ï–ù–ï–ù–û)

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω —Ñ–∞–π–ª `ip_adapter/instantId.py` - –∑–∞–º–µ–Ω–µ–Ω hardcoded `torch.float16` –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ:

```python
# –ë—ã–ª–æ:
dtype = torch.float16

# –°—Ç–∞–ª–æ:
dtype = q.dtype  # Auto-detect from query tensor
```

–¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç NaN/Inf –≤ `ip_adapter/resampler.py`:
```python
output = torch.clamp(output, min=-65504, max=65504)
```

### üîß –†–µ—à–µ–Ω–∏–µ 2: –ê—Ä–≥—É–º–µ–Ω—Ç—ã –∑–∞–ø—É—Å–∫–∞ ComfyUI

–ï—Å–ª–∏ –†–µ—à–µ–Ω–∏–µ 1 –Ω–µ –ø–æ–º–æ–≥–ª–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å ComfyUI —Å:

```bash
# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π float16 –¥–ª—è –≤—Å–µ–≥–æ
python main.py --force-fp16

# –ò–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π float32 (–º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ)
python main.py --force-fp32
```

### üîß –†–µ—à–µ–Ω–∏–µ 3: –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã–π VAE —Ä–µ–∂–∏–º

–î–æ–±–∞–≤—å—Ç–µ –≤ —Ñ–∞–π–ª `extra_model_paths.yaml` –∏–ª–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ComfyUI:

```yaml
attention_mode: "split"  # –í–º–µ—Å—Ç–æ –Ω–æ–≤–æ–≥–æ "pytorch"
```

### üîß –†–µ—à–µ–Ω–∏–µ 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Ä—Å–∏—é onnxruntime-gpu (–ö–†–ò–¢–ò–ß–ù–û!)

**–≠—Ç–æ —Å–∞–º–æ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –µ—Å–ª–∏ NaN –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ Resampler!**

–í–µ—Ä—Å–∏–∏ onnxruntime-gpu >= 1.17 –∏–º–µ—é—Ç –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å NaN –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö:

```bash
# –£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é
pip uninstall onnxruntime-gpu onnxruntime

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω—É—é –≤–µ—Ä—Å–∏—é
pip install onnxruntime-gpu==1.16.3

# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å ComfyUI
```

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–µ—Ä—Å–∏—é:**
```bash
python -c "import onnxruntime; print(onnxruntime.__version__)"
```

### üîß –†–µ—à–µ–Ω–∏–µ 5: –û—Ç–∫–ª—é—á–∏—Ç—å lowvram —Ä–µ–∂–∏–º

–ï—Å–ª–∏ —É –≤–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ VRAM (>8GB), –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–∑ lowvram:

```bash
python main.py --normalvram
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –†–µ—à–µ–Ω–∏—è 1 (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ), –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ ComfyUI –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å.

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –æ—Å—Ç–∞–ª–∞—Å—å, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–µ—à–µ–Ω–∏—è 2-5 –ø–æ –æ—á–µ—Ä–µ–¥–∏.

## –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π: NaN –≤ Resampler

### –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ –≤ –ª–æ–≥–∞—Ö:
```
[Resampler WARNING] Pre-clamp NaN: True, Inf: False
```

**–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç**: –ü—Ä–æ–±–ª–µ–º–∞ –ù–ï –≤ dtype, –∞ –≤ InsightFace/onnxruntime!

### –†–µ—à–µ–Ω–∏–µ –¥–ª—è NaN –≤ Resampler:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é onnxruntime:**
   ```bash
   python -c "import onnxruntime; print(onnxruntime.__version__)"
   ```

2. **–ï—Å–ª–∏ >= 1.17, –ø–æ–Ω–∏–∑—å—Ç–µ –¥–æ 1.16.3:**
   ```bash
   pip uninstall onnxruntime-gpu onnxruntime
   pip install onnxruntime-gpu==1.16.3
   ```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ ONNX –º–æ–¥–µ–ª–∏:**
   –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã:
   ```bash
   ls -lh ComfyUI/models/insightface/models/antelopev2/
   # –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 5 —Ñ–∞–π–ª–æ–≤: 1k3d68.onnx, 2d106det.onnx, genderage.onnx, glintr100.onnx, scrfd_10g_bnkps.onnx
   ```

4. **–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –º–æ–¥–µ–ª–∏:**
   –£–¥–∞–ª–∏—Ç–µ –∏ —Å–∫–∞—á–∞–π—Ç–µ –∑–∞–Ω–æ–≤–æ AntelopeV2 –º–æ–¥–µ–ª–∏

### –í—Ä–µ–º–µ–Ω–Ω—ã–π workaround
–ö–æ–¥ —Ç–µ–ø–µ—Ä—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç zero tensor –≤–º–µ—Å—Ç–æ NaN, —á—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —á–µ—Ä–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç, –Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç—Ä–∞–¥–∞–µ—Ç. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç —Å–∏—Å—Ç–µ–º–µ —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ–∫–∞ –≤—ã –Ω–µ –∏—Å–ø—Ä–∞–≤–∏—Ç–µ root cause.

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å

–ö–æ–¥ —Ç–µ–ø–µ—Ä—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–≤–æ–¥–∏—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å ComfyUI:

```
[Resampler Debug] Input dtype: torch.float32, shape: torch.Size([1, 1, 512])
[FaceEmbedCombine Debug] Input embeds dtype: torch.float32, shape: torch.Size([1, 512])
[InstantIdAdapterApply Debug] Conditioning dtype: torch.float32, shape: torch.Size([1, 16, 2048])
  Strength: 0.8, has NaN: False, has Inf: False
[InstantID Debug] Query dtype: torch.bfloat16, device: cuda:0
```

### –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å:

1. **Dtype —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ**: Query dtype –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å Conditioning dtype (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è)
2. **NaN/Inf –∑–Ω–∞—á–µ–Ω–∏—è**: –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ `WARNING` –∏–ª–∏ `ERROR` —Å–æ–æ–±—â–µ–Ω–∏—è - –ø—Ä–æ–±–ª–µ–º–∞ –Ω–∞–π–¥–µ–Ω–∞
3. **Device –ºismatch**: –í—Å–µ —Ç–µ–Ω–∑–æ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ `cuda:0` (–∏–ª–∏ –æ–¥–Ω–æ–º device)

### –ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:

```
[Resampler WARNING] Pre-clamp NaN: True, Inf: False
  Output stats: min=nan, max=nan, mean=nan
[FaceEmbedCombine ERROR] NaN/Inf detected in conditionings!
  Stats: min=nan, max=nan
```

–ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Ç–∞–∫–∏–µ –æ—à–∏–±–∫–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:
- –†–µ—à–µ–Ω–∏–µ 2: –ó–∞–ø—É—Å—Ç–∏—Ç—å ComfyUI —Å `--force-fp32`
- –†–µ—à–µ–Ω–∏–µ 4: –ü–æ–Ω–∏–∑–∏—Ç—å –≤–µ—Ä—Å–∏—é onnxruntime-gpu –¥–æ 1.16.3
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å CUDA –≤–µ—Ä—Å–∏—é: `nvidia-smi` –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å PyTorch

### –û—Ç–∫–ª—é—á–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–≤–æ–¥

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª—é—á–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã, –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Å `print(` –≤:
- `ip_adapter/instantId.py` (—Å—Ç—Ä–æ–∫–∏ 33, 42-44, 51-54)
- `ip_adapter/resampler.py` (—Å—Ç—Ä–æ–∫–∏ 108, 124-126, 132-133)
- `nodes.py` (—Å—Ç—Ä–æ–∫–∏ 93, 100-102, 261-262)
