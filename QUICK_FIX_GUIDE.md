# Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ‡ÐµÑ€Ð½Ð¾Ð³Ð¾ ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð°

## Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ ÑÐ´ÐµÐ»Ð°Ð½Ð¾

âœ… **Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½ hardcoded dtype ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚** - Ð³Ð»Ð°Ð²Ð½Ð°Ñ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ð° Ñ‡ÐµÑ€Ð½Ñ‹Ñ… ÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð¾Ð²
âœ… **Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð° Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ NaN/Inf** - Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ Ñ€Ð°ÑÐ¿Ñ€Ð¾ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº
âœ… **Ð’ÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ð¿Ð¾Ð»Ð½Ð°Ñ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ°** - Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

## Ð§Ñ‚Ð¾ Ð´ÐµÐ»Ð°Ñ‚ÑŒ ÑÐµÐ¹Ñ‡Ð°Ñ

### Ð¨Ð°Ð³ 1: ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ComfyUI
```bash
# ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ComfyUI (Ctrl+C)
# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð·Ð°Ð½Ð¾Ð²Ð¾
python main.py
```

### Ð¨Ð°Ð³ 2: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÑŽ Ñ Ð²Ð°ÑˆÐ¸Ð¼ workflow

### Ð¨Ð°Ð³ 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ ÐºÐ¾Ð½ÑÐ¾Ð»ÑŒ ComfyUI

**ÐÐ¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ (Ð²ÑÑ‘ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚):**
```
[Resampler Debug] Input dtype: torch.float32, shape: torch.Size([1, 1, 512])
[InstantID Debug] Query dtype: torch.bfloat16, device: cuda:0
```
âœ… ÐÐ¸ÐºÐ°ÐºÐ¸Ñ… WARNING/ERROR - Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ñ€ÐµÑˆÐµÐ½Ð°!

**ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ð½Ñ‹Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ (Ð½ÑƒÐ¶Ð½Ñ‹ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ):**
```
[Resampler WARNING] Pre-clamp NaN: True, Inf: False
[InstantID ERROR] NaN/Inf in output at layer 5!
```
âŒ ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ðº [FIX_BLACK_SQUARE.md](FIX_BLACK_SQUARE.md) Ð´Ð»Ñ Ñ€ÐµÑˆÐµÐ½Ð¸Ð¹ 2-5

## Ð•ÑÐ»Ð¸ Ð²ÑÑ‘ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚

ÐŸÐ¾Ð·Ð´Ñ€Ð°Ð²Ð»ÑÑŽ! ÐœÐ¾Ð¶ÐµÑ‚Ðµ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾):

1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:
   - `ip_adapter/instantId.py`
   - `ip_adapter/resampler.py`
   - `nodes.py`

2. ÐÐ°Ð¹Ð´Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð¾ÐºÐ¸ Ñ `print(f"[InstantID` Ð¸ `print(f"[Resampler`

3. Ð—Ð°ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð¸Ñ… Ð´Ð¾Ð±Ð°Ð²Ð¸Ð² `#` Ð² Ð½Ð°Ñ‡Ð°Ð»Ðµ:
   ```python
   # print(f"[InstantID Debug] Query dtype: {dtype}, device: {q.device}")
   ```

## Ð¢ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸

**Ð§Ñ‚Ð¾ Ð±Ñ‹Ð»Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾:**
- [ip_adapter/instantId.py:32](ip_adapter/instantId.py#L32) - Auto-detect dtype Ð²Ð¼ÐµÑÑ‚Ð¾ hardcoded float16
- [ip_adapter/resampler.py:121](ip_adapter/resampler.py#L121) - Clamp Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ NaN/Inf
- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð´Ð¸Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼

**ÐŸÐ¾Ñ‡ÐµÐ¼Ñƒ ÑÑ‚Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚:**
ÐÐ¾Ð²Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ ComfyUI Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ `bfloat16` Ð´Ð»Ñ VAE Ð²Ð¼ÐµÑÑ‚Ð¾ `float16`. Ð¡Ñ‚Ð°Ñ€Ñ‹Ð¹ ÐºÐ¾Ð´ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð» Ð²ÑÑ‘ Ð² `float16`, Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ð»Ð¾ NaN Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¸ Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑÑ…. Ð¢ÐµÐ¿ÐµÑ€ÑŒ dtype Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸Ð· Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ñ… Ñ‚ÐµÐ½Ð·Ð¾Ñ€Ð¾Ð².

## Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ

Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ð° Ð½Ðµ Ñ€ÐµÑˆÐµÐ½Ð°:
- ðŸ“– Ð§Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ [FIX_BLACK_SQUARE.md](FIX_BLACK_SQUARE.md) - Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾
- ðŸ“‹ Ð¡ÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð²Ñ‹Ð²Ð¾Ð´ ÐºÐ¾Ð½ÑÐ¾Ð»Ð¸ Ñ `[InstantID]` Ð¸ `[Resampler]` ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼Ð¸
- ðŸ› Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Issue Ñ Ð»Ð¾Ð³Ð°Ð¼Ð¸ Ð½Ð° GitHub

## Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²ÐµÑ€ÑÐ¸Ð¹

```bash
# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ PyTorch Ð²ÐµÑ€ÑÐ¸ÑŽ
python -c "import torch; print(f'PyTorch: {torch.__version__}, CUDA: {torch.version.cuda}')"

# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ onnxruntime-gpu
pip show onnxruntime-gpu

# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ CUDA Ð´Ñ€Ð°Ð¹Ð²ÐµÑ€
nvidia-smi
```

Ð¡Ð¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:
- PyTorch >= 2.0 Ñ CUDA 11.8/12.1
- onnxruntime-gpu 1.16.x - 1.19.x
- CUDA Driver >= 11.8
